
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbor Classroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <style>
        body { background-color: #202020; color: white; font-family: 'VT323', monospace; overflow: hidden; user-select: none; }
        #game-container { position: relative; width: 1024px; height: 768px; margin: 20px auto; background-color: #353535; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 4px solid #555; image-rendering: pixelated; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .pixel-panel { background: #fff; border: 4px solid #000; box-shadow: 4px 4px 0px #000; color: #000; font-family: 'VT323', monospace; font-size: 1.5rem; line-height: 1.2; }
        .dialogue-box { position: absolute; bottom: 20px; left: 20px; right: 20px; height: 180px; padding: 20px; display: none; z-index: 10; }
        .dialogue-name { position: absolute; top: -20px; left: 20px; background: #000; color: #fff; padding: 5px 15px; font-family: 'Press Start 2P', cursive; font-size: 0.8rem; border: 2px solid #fff; }
        #input-area { position: absolute; bottom: 25px; left: 30px; right: 30px; display: none; gap: 10px; z-index: 20; }
        input[type="text"] { flex: 1; background: #000; color: #0f0; border: 2px solid #fff; padding: 10px; font-family: 'VT323', monospace; font-size: 1.5rem; outline: none; }
        
        /* SCOREBOARD */
        #scoreboard { position: absolute; top: 20px; left: 20px; width: 180px; background: rgba(0,0,0,0.8); border: 2px solid #fff; padding: 10px; z-index: 5; font-size: 1.2rem; }
        .score-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .active-turn { color: #ffff00; text-shadow: 0 0 5px #ffff00; font-weight: bold; }
        .score-correct { color: #0f0; }
        .score-wrong { color: #f00; }
    </style>
</head>
<body>
    
    <div id="game-container">
        <canvas id="world"></canvas>
        
        <!-- Scoreboard -->
        <div id="scoreboard">
            <div class="text-center border-b border-white mb-2 pb-1 font-bold text-yellow-400">CLASS RANK</div>
            <div id="scores-list"></div>
        </div>

        <!-- Dialogue UI -->
        <div id="dialogue-box" class="dialogue-box pixel-panel">
            <div id="dialogue-name" class="dialogue-name">SISTEMA</div>
            <div id="dialogue-text">Cargando...</div>
            <div id="dialogue-hint" class="absolute bottom-2 right-4 text-xs text-gray-400 animate-pulse hidden">▼ SPACE</div>
        </div>
        
        <!-- Player Input -->
        <div id="input-area">
            <input type="text" id="player-input" placeholder="Tu respuesta..." autocomplete="off">
            <button onclick="Game.submitPlayerAnswer()" class="bg-green-600 text-white px-6 border-2 border-white font-bold hover:bg-green-500">RESPONDER</button>
        </div>
    </div>

<script>
/**
 * ARBOR CLASSROOM - TURN BASED
 */

const Game = {
    canvas: null, ctx: null, state: 'INIT',
    
    // Actors
    prof: { x: 512, y: 150, frame: 0 },
    students: [
        { id: 'lola', name: 'Lola', x: 250, y: 450, color: '#e11d48', isPlayer: false, score: 0, accuracy: 0.9 }, // Smart
        { id: 'timmy', name: 'Timmy', x: 512, y: 450, color: '#2563eb', isPlayer: false, score: 0, accuracy: 0.6 }, // Average
        { id: 'player', name: 'YOU', x: 774, y: 450, color: '#16a34a', isPlayer: true, score: 0 } // Player
    ],
    
    // Game Data
    lessonText: "",
    concepts: [], // { topic, question, answer_key }
    
    // Loop State
    currentConceptIndex: 0,
    currentTurnIndex: 0, // 0=Lola, 1=Timmy, 2=Player
    canAdvance: false,

    init: async function() {
        this.canvas = document.getElementById('world');
        this.canvas.width = 1024; this.canvas.height = 768;
        this.ctx = this.canvas.getContext('2d');
        
        // Setup Player Name from Arbor Context
        if (window.Arbor && window.Arbor.user) {
            this.students[2].name = window.Arbor.user.username.toUpperCase();
        }

        this.startRenderLoop();
        this.updateScoreboard();
        await this.loadLevel();
    },

    async loadLevel() {
        this.uiShowDialog("SISTEMA", "Descargando lección...");
        
        // 1. Fetch Text
        let rawText = "";
        if (window.Arbor && window.Arbor.content) {
            try {
                const lesson = await window.Arbor.content.getNext();
                if (lesson) rawText = lesson.text;
                else rawText = "Bienvenido a la clase de prueba. El conocimiento es poder.";
            } catch(e) { rawText = "Error loading content."; }
        }
        this.lessonText = rawText;

        // 2. AI Extraction (Concepts)
        this.uiShowDialog("PROFESOR", "Preparando la clase de hoy...");
        
        // Prompt for 3 distinct concepts
        const prompt = `
        Texto: "${this.lessonText.substring(0, 2000)}".
        Tarea: Extrae 3 conceptos CLAVE distintos.
        Para cada uno, crea una pregunta ESPECÍFICA y una respuesta breve.
        JSON: {
            "intro": "Resumen de la clase en 10 palabras.",
            "concepts": [
                { "topic": "Concepto 1", "question": "Pregunta específica sobre Concepto 1", "key": "Respuesta correcta breve" },
                { "topic": "Concepto 2", "question": "Pregunta específica sobre Concepto 2", "key": "Respuesta correcta breve" },
                { "topic": "Concepto 3", "question": "Pregunta específica sobre Concepto 3", "key": "Respuesta correcta breve" }
            ]
        }`;

        try {
            const res = await window.Arbor.ai.chat([{role:"user", content: prompt}]);
            const json = this.parseJSON(res);
            
            if (json && json.concepts && json.concepts.length >= 3) {
                this.concepts = json.concepts.slice(0, 3);
                this.uiShowDialog("PROFESOR", json.intro || "Empecemos.");
            } else {
                // Fallback
                this.concepts = [
                    { topic: "General", question: "¿De qué trata el texto?", key: "Del tema principal" },
                    { topic: "Detalle", question: "¿Menciona un detalle?", key: "Cualquier detalle válido" },
                    { topic: "Conclusión", question: "¿Cuál es la conclusión?", key: "El final" }
                ];
                this.uiShowDialog("PROFESOR", "Vamos a repasar el texto.");
            }
            
            this.state = 'WAIT_INTRO';
            window.addEventListener('keydown', this.handleInput);

        } catch(e) {
            this.uiShowDialog("SISTEMA", "Error IA: " + e.message);
        }
    },

    async startTurn() {
        // Reset or Loop
        if (this.currentTurnIndex >= 3) {
            // End of round, maybe load next lesson?
            this.uiShowDialog("PROFESOR", "¡Clase terminada! Cargando siguiente tema...");
            setTimeout(() => location.reload(), 3000); 
            return;
        }

        const student = this.students[this.currentTurnIndex];
        const concept = this.concepts[this.currentTurnIndex]; // 1 concept per student
        
        this.updateScoreboard();

        // Step 1: Teacher asks
        this.state = 'ASKING';
        this.uiShowDialog("PROFESOR", `${student.name}, ${concept.question}`);
        
        await this.wait(2500);

        // Step 2: Student Responds
        if (!student.isPlayer) {
            this.state = 'NPC_THINKING';
            // Simulate AI Answer
            const shouldFail = Math.random() > student.accuracy;
            const contextPrompt = `
            Pregunta: "${concept.question}". 
            Respuesta Correcta: "${concept.key}".
            Rol: Estudiante ${shouldFail ? "confundido/erróneo" : "correcto"}.
            Tarea: Genera una respuesta corta (max 8 palabras).
            `;
            
            const ansRes = await window.Arbor.ai.chat([{role:"user", content:contextPrompt}]);
            const ansText = ansRes.replace(/"/g, '');
            
            this.uiShowDialog(student.name, ansText);
            await this.wait(2000);
            
            // Grading
            this.evaluate(student, ansText, concept, shouldFail);

        } else {
            // Player Turn
            this.state = 'PLAYER_INPUT';
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('player-input').focus();
            this.uiShowDialog(student.name, "(Es mi turno...)");
        }
    },

    async submitPlayerAnswer() {
        const input = document.getElementById('player-input');
        const ans = input.value.trim();
        if (!ans) return;
        
        input.value = '';
        document.getElementById('input-area').style.display = 'none';
        
        // Evaluate Player
        const concept = this.concepts[this.currentTurnIndex];
        const student = this.students[this.currentTurnIndex];
        
        this.uiShowDialog("PROFESOR", "Mmm...");
        
        // AI Judge
        const prompt = `
        Pregunta: "${concept.question}".
        Respuesta Alumno: "${ans}".
        Respuesta Correcta: "${concept.key}".
        Contexto Texto: "${this.lessonText.substring(0, 500)}".
        Tarea: Evaluar. JSON: {"correct": true/false, "feedback": "muy breve feedback"}
        `;
        
        const res = await window.Arbor.ai.chat([{role:"user", content:prompt}]);
        const json = this.parseJSON(res);
        const correct = json?.correct || false;
        
        this.evaluate(student, ans, concept, !correct, json?.feedback);
    },

    evaluate(student, answer, concept, forcedFail = false, aiFeedback = null) {
        let isCorrect = !forcedFail;
        let feedback = aiFeedback || (isCorrect ? "¡Correcto!" : "Incorrecto.");
        
        this.uiShowDialog("PROFESOR", feedback);
        
        if (isCorrect) {
            student.score++;
            // Confetti for player
            if (student.isPlayer && window.Arbor.game) window.Arbor.game.addXP(20);
        }
        
        this.updateScoreboard();
        
        // Next Turn
        setTimeout(() => {
            this.currentTurnIndex++;
            this.startTurn();
        }, 2500);
    },

    handleInput: (e) => {
        if (e.code === 'Space') {
            if (Game.state === 'WAIT_INTRO') {
                Game.currentTurnIndex = 0;
                window.removeEventListener('keydown', Game.handleInput);
                Game.startTurn();
            }
        } else if (e.code === 'Enter' && Game.state === 'PLAYER_INPUT') {
            Game.submitPlayerAnswer();
        }
    },

    // --- RENDER ---
    startRenderLoop() {
        const loop = () => { this.draw(); requestAnimationFrame(loop); };
        loop();
    },

    draw() {
        const ctx = this.ctx; const w = 1024; const h = 768;
        
        // Room
        ctx.fillStyle = '#5d4037'; ctx.fillRect(0, 300, w, h-300); // Floor
        ctx.fillStyle = '#d4d4d4'; ctx.fillRect(0, 0, w, 300); // Wall
        
        // Blackboard
        ctx.fillStyle = '#2e3b28'; ctx.fillRect(200, 20, 624, 200);
        ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 8; ctx.strokeRect(200, 20, 624, 200);
        
        // Chalk Text
        ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.font = '20px monospace';
        
        // Concepts List on Board
        if (this.concepts.length > 0) {
            ctx.fillText("CLASE DE HOY:", 220, 60);
            this.concepts.forEach((c, i) => {
                // Dim if done
                const done = i < this.currentTurnIndex;
                ctx.fillStyle = done ? 'rgba(255,255,255,0.3)' : 'white';
                // Mark current
                const prefix = (i === this.currentTurnIndex) ? "► " : "  ";
                ctx.fillText(prefix + c.topic, 220, 100 + (i * 40));
            });
        } else {
            ctx.fillText("Cargando...", 450, 120);
        }

        // Professor
        ctx.fillStyle = '#ffccaa'; ctx.fillRect(this.prof.x, this.prof.y, 50, 50); // Head
        ctx.fillStyle = '#1e293b'; ctx.fillRect(this.prof.x - 10, this.prof.y + 50, 70, 90); // Body

        // Students & Desks
        this.students.forEach((s, i) => {
            const isTurn = i === this.currentTurnIndex;
            
            // Desk
            ctx.fillStyle = '#8d6e63'; ctx.fillRect(s.x - 60, s.y, 120, 80);
            
            // Student Body
            ctx.fillStyle = s.color; ctx.fillRect(s.x - 25, s.y - 50, 50, 60);
            // Head
            ctx.fillStyle = '#ffccaa'; ctx.fillRect(s.x - 20, s.y - 85, 40, 40);
            
            // Turn Marker
            if (isTurn) {
                ctx.fillStyle = 'yellow';
                ctx.beginPath(); ctx.moveTo(s.x, s.y - 110); ctx.lineTo(s.x - 10, s.y - 125); ctx.lineTo(s.x + 10, s.y - 125); ctx.fill();
            }
        });
    },

    updateScoreboard() {
        const list = document.getElementById('scores-list');
        list.innerHTML = this.students.map((s, i) => `
            <div class="score-row ${i === this.currentTurnIndex ? 'active-turn' : ''}">
                <span>${s.name}</span>
                <span>${s.score} ★</span>
            </div>
        `).join('');
    },

    uiShowDialog(name, text) {
        const box = document.getElementById('dialogue-box');
        const txt = document.getElementById('dialogue-text');
        const hint = document.getElementById('dialogue-hint');
        
        box.style.display = 'block';
        document.getElementById('dialogue-name').innerText = name;
        
        hint.style.display = 'none';
        this.canAdvance = false;
        txt.innerHTML = '';
        
        let i = 0;
        if(this.typeInt) clearInterval(this.typeInt);
        this.typeInt = setInterval(() => {
            txt.textContent += text.charAt(i);
            i++;
            if(i > text.length) {
                clearInterval(this.typeInt);
                this.canAdvance = true;
                if (name === "SISTEMA" || name === "PROFESOR") hint.style.display = 'block';
            }
        }, 15);
    },

    wait(ms) { return new Promise(r => setTimeout(r, ms)); },
    parseJSON(str) { try { return JSON.parse(str.substring(str.indexOf('{'), str.lastIndexOf('}')+1)); } catch(e){return null;} }
};

window.onload = () => Game.init();
</script>
</body>
</html>
